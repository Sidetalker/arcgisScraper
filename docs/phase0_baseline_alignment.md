# Phase 0 Baseline Alignment Findings

## Current Data Flow Inventory

### CLI exports generated by `scrape_arcgis.py`
- **JSON feature dump (`--output`)** – when `--owner-table` is not enabled the CLI writes the queried feature set to stdout and optionally to a file path passed via `--output`, preserving the ArcGIS template metadata and geometry payloads.【F:scrape_arcgis.py†L318-L518】
- **Owner contact CSV (`--owner-table`)** – formats every matched parcel into a mail-merge friendly CSV, including complex, unit, mailing address, subdivision, and the canonical schedule number; the same routine feeds the Excel writer and is sorted by complex/unit so downstream spreadsheets remain stable.【F:scrape_arcgis.py†L487-L704】
- **Two-sheet Excel workbook (`--excel-output`)** – supplements the CSV by building "By Complex" and "By Owner" tabs with cross-sheet hyperlinks and optional Google Sheets links governed by `--sheets-doc-id`, `--complex-gid`, and `--owner-gid`.【F:scrape_arcgis.py†L337-L344】【F:scrape_arcgis.py†L501-L511】【F:scrape_arcgis.py†L880-L1057】
- **Workbook hyperlink rewrite (`--rewrite-xlsx`)** – allows retargeting previously generated Excel files so hyperlinks stay valid after moving documents between Google Sheets and local workbooks.【F:scrape_arcgis.py†L345-L411】【F:scrape_arcgis.py†L1032-L1127】

### Supabase persistence and downstream consumers
- **Primary listings table** – `public.listings` stores one row per STR license with owner contact columns, subdivision, and `schedule_number`, plus indexes that optimise schedule-based joins and subdivision aggregations.【F:supabase/listings.sql†L1-L42】
- **Aggregated metrics** – supporting tables and views (`listing_subdivision_metrics`, `listing_renewal_metrics`, `listing_renewal_summary`, `listing_renewal_method_summary`, and their read-only views) expose subdivision counts and renewal timelines for the React dashboard.【F:supabase/listing_metrics.sql†L3-L138】
- **Edge refresh job** – the `refresh-listing-metrics` Supabase Edge Function reuses the shared aggregation script and enforces authentication or a refresh token before recalculating metrics, keeping Supabase in sync with new imports.【F:supabase/functions/refresh-listing-metrics/index.ts†L1-L63】【F:supabase/functions/refresh-listing-metrics/index.ts†L38-L72】
- **React data loaders** – the web client pulls the denormalised `listings` rows via `fetchStoredListings`, ordering by `schedule_number`, and fetches dashboard metrics from the published views; it can also trigger the edge refresh when authorised.【F:webapp/arcgis-webapp/src/services/listingStorage.ts†L61-L280】【F:webapp/arcgis-webapp/src/services/listingMetrics.ts†L1-L211】

## Common Parcel Identifier Mapping

- The CLI extracts the Summit County parcel schedule from the `PropertyScheduleText` feature attribute and stores it in the "Schedule Number" column shared across CSV and Excel exports.【F:scrape_arcgis.py†L627-L704】
- The same identifier is persisted in Supabase as `schedule_number` with an index to optimise joins, while React models expose it as `scheduleNumber` and rely on it for ordering and record matching.【F:supabase/listings.sql†L1-L33】【F:webapp/arcgis-webapp/src/services/listingStorage.ts†L61-L280】【F:webapp/arcgis-webapp/src/types.ts†L51-L76】
- Owner hyperlink fallbacks use `HC_RegistrationsOriginalCleaned` only when the schedule number is missing, so new data sources should continue to prefer `PropertyScheduleText` and treat blank schedules as exceptional cases to avoid ambiguous joins.【F:scrape_arcgis.py†L644-L699】

## Gap Analysis Summary

- **Join reliability:** Schedule numbers flow consistently from ArcGIS through Supabase into the React app, but records lacking `PropertyScheduleText` remain blank at every stage; enrichment feeds must either drop empty schedules or provide remediation rules before ingestion.【F:scrape_arcgis.py†L644-L699】【F:supabase/listings.sql†L1-L33】
- **Owner enrichment surface area:** The CSV/Excel outputs include rich owner contact columns that are not all surfaced in Supabase metrics views, so compliance overlays targeting owner communications should either extend the `listings` table or derive dedicated owner-level tables to avoid recomputing from raw CSVs.【F:scrape_arcgis.py†L627-L704】【F:supabase/listing_metrics.sql†L3-L138】
- **Automation touchpoints:** Dashboard metrics depend on the edge refresh workflow; any new datasets that influence renewals or subdivision aggregates need corresponding refresh hooks (either extending the existing function or introducing new jobs) to keep the UI in sync.【F:supabase/functions/refresh-listing-metrics/index.ts†L1-L72】【F:webapp/arcgis-webapp/src/services/listingMetrics.ts†L195-L211】
